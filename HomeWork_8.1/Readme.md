# Домашнее задание к занятию "08.01 Введение в Ansible"

## Подготовка к выполнению
#### 1. Установите ansible версии 2.10 или выше.

Установим Ansible
```
# apt update
# apt install ansible
```

Проверим, чо все установилось и версия нам подходит
```
# ansible --version
ansible [core 2.14.1]
  config file = None
  configured module search path = ['/root/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/lib/python3/dist-packages/ansible
  ansible collection location = /root/.ansible/collections:/usr/share/ansible/collections
  executable location = /usr/bin/ansible
  python version = 3.11.1 (main, Dec 31 2022, 10:23:59) [GCC 12.2.0] (/usr/bin/python3)
  jinja version = 3.0.3
  libyaml = True
```
#### 2. Создайте свой собственный публичный репозиторий на github с произвольным именем.

https://github.com/Artegro/ansible-8.1/tree/master

#### 3. Скачайте [playbook](./playbook/) из репозитория с домашним заданием и перенесите его в свой репозиторий.
Перенесли в свой репозиторий, проверим что все приехало на тестовую машину
```
# git pull https://github.com/Artegro/ansible-8.1.git
# ls -l
total 16
-rw-r--r-- 1 root root 1293 Jan 26 14:39 README.md
drwxr-xr-x 5 root root 4096 Jan 26 14:39 group_vars
drwxr-xr-x 2 root root 4096 Jan 26 14:39 inventory
-rw-r--r-- 1 root root  209 Jan 26 14:39 site.yml

```

## Основная часть
#### 1. Попробуйте запустить playbook на окружении из `test.yml`, зафиксируйте какое значение имеет факт `some_fact` для указанного хоста при выполнении playbook'a.
Запустим playbook
```
# ansible-playbook -i inventory/test.yml site.yml

PLAY [Print os facts] ******************************************************************************************************************************************************************************

TASK [Gathering Facts] *****************************************************************************************************************************************************************************
ok: [localhost]

TASK [Print OS] ************************************************************************************************************************************************************************************
ok: [localhost] => {
    "msg": "Debian"
}

TASK [Print fact] **********************************************************************************************************************************************************************************
ok: [localhost] => {
    "msg": 12
}

PLAY RECAP *****************************************************************************************************************************************************************************************
localhost                  : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

```

#### 2. Найдите файл с переменными (group_vars) в котором задаётся найденное в первом пункте значение и поменяйте его на 'all default fact'.
Заменим и проверим результат
```
# nano group_vars/all/examp.yml

# cat group_vars/all/examp.yml
---
  some_fact: all default fact

```

#### 3. Воспользуйтесь подготовленным (используется `docker`) или создайте собственное окружение для проведения дальнейших испытаний.
Подготовим Докер
```
apt -y install  ca-certificates curl gnupg lsb-release
mkdir -p /etc/apt/keyrings
echo  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
apt update
apt -y  install docker-ce docker-ce-cli containerd.io docker-compose-plugin
```
Проверим что все установилось
```
docker -v
Docker version 20.10.23, build 7155243

docker run --name centos7 -d pycontribs/centos:7 sleep 36000000 && docker run --name ubuntu -d pycontribs/ubuntu sleep 65000000
```
#### 4. Проведите запуск playbook на окружении из `prod.yml`. Зафиксируйте полученные значения `some_fact` для каждого из `managed host`.
```
# ansible-playbook -i inventory/prod.yml -v site.yml
No config file found; using defaults

PLAY [Print os facts] ******************************************************************************************************************************************************************************

TASK [Gathering Facts] *****************************************************************************************************************************************************************************
ok: [ubuntu]
ok: [centos7]

TASK [Print OS] ************************************************************************************************************************************************************************************
ok: [centos7] => {
    "msg": "CentOS"
}
ok: [ubuntu] => {
    "msg": "Ubuntu"
}

TASK [Print fact] **********************************************************************************************************************************************************************************
ok: [centos7] => {
    "msg": "el"
}
ok: [ubuntu] => {
    "msg": "deb"
}

PLAY RECAP *****************************************************************************************************************************************************************************************
centos7                    : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ubuntu                     : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0


```

#### 5. Добавьте факты в `group_vars` каждой из групп хостов так, чтобы для `some_fact` получились следующие значения: для `deb` - 'deb default fact', для `el` - 'el default fact'.
Попарвим соответствующие файлы
```
# nano group_vars/deb/examp.yml
cat group_vars/deb/examp.yml
---
<<<<<<< HEAD
  some_fact: "deb default fact"

# nano group_vars/el/examp.yml
cat group_vars/el/examp.yml
---
<<<<<<< HEAD
  some_fact: "el default fact"
```

#### 6. Повторите запуск playbook на окружении `prod.yml`. Убедитесь, что выдаются корректные значения для всех хостов.

Проверим что все получилось 
```
# ansible-playbook -i inventory/prod.yml -v site.yml
No config file found; using defaults

PLAY [Print os facts] ******************************************************************************************************************************************************************************

TASK [Gathering Facts] *****************************************************************************************************************************************************************************
ok: [ubuntu]
ok: [centos7]

TASK [Print OS] ************************************************************************************************************************************************************************************
ok: [centos7] => {
    "msg": "CentOS"
}
ok: [ubuntu] => {
    "msg": "Ubuntu"
}

TASK [Print fact] **********************************************************************************************************************************************************************************
ok: [centos7] => {
    "msg": "el default fact"
}
ok: [ubuntu] => {
    "msg": "deb default fact"
}

PLAY RECAP *****************************************************************************************************************************************************************************************
centos7                    : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ubuntu                     : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

```

#### 7. При помощи `ansible-vault` зашифруйте факты в `group_vars/deb` и `group_vars/el` с паролем `netology`.
Зашифруем файлы целеком
```
# ansible-vault encrypt group_vars/el/examp.yml
New Vault password:
Confirm New Vault password:
Encryption successful

# ansible-vault encrypt group_vars/deb/examp.yml
New Vault password:
Confirm New Vault password:
Encryption successful
```
Проверим
```
# cat group_vars/deb/examp.yml
$ANSIBLE_VAULT;1.1;AES256
61316265353163343331396130663062653932663265656666306639363230333338666664333539
6361653338363666343861626331303436646237643435360a613265666233616535303061653033
36616362303530373930626261343438663263313162333331346531386261633530663539333432
6135313231316234330a356463383061366337326633623861353632663161643337333733383530
31393734386164623661386337393763653235653631333466333037663038616530396361663833
32316138653231376566666466626463626630386334396130306165623861386266343764343935
38393031363166623937346663653037373231633432313537316334623931363366663862333937
36323261356236363438336262323834383766303463343938326631383538376664643238313665
38356463626231373731353566623933663831356466356265633431613736393438633931653365
39643962363737363635346138616663646439336263653963643062636636386361643738376636
306334383932346537643232396261353133

# cat group_vars/el/examp.yml
$ANSIBLE_VAULT;1.1;AES256
36616665333437633635623332663264303930653530653661383935616438356630383939656161
3232643664323662626332646563323035366661643139620a336266353561343438366362323664
32653364373538316337376330646666356332626639366666306462313739333739356232303233
3034623961336237340a663863613632316135343530623338383433636131653161313537393136
39353733343866356263313638383738626335646330633964306136336131333536643063383564
35386330346365353335393131393762306432306665663264613233363439666462363136353061
38356130313239366635313634383530316163376564366365373137336564653035633266626664
39346465656366326164323034383638613434303165653965326361323334626436643736656464
38366639393061343164313032646532383731643137666662626330613132326136323766623865
30616139356336313338366239376262373066636634336337386139396266313263363863346532
623235386361663333643136313632343064

```

#### 8. Запустите playbook на окружении `prod.yml`. При запуске `ansible` должен запросить у вас пароль. Убедитесь в работоспособности.

```
# ansible-playbook -i inventory/prod.yml site.yml --ask-vault-pass
Vault password:

PLAY [Print os facts] ******************************************************************************************************************************************************************************

TASK [Gathering Facts] *****************************************************************************************************************************************************************************
ok: [ubuntu]
ok: [centos7]

TASK [Print OS] ************************************************************************************************************************************************************************************
ok: [centos7] => {
    "msg": "CentOS"
}
ok: [ubuntu] => {
    "msg": "Ubuntu"
}

TASK [Print fact] **********************************************************************************************************************************************************************************
ok: [centos7] => {
    "msg": "el default fact"
}
ok: [ubuntu] => {
    "msg": "deb default fact"
}

PLAY RECAP *****************************************************************************************************************************************************************************************
centos7                    : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ubuntu                     : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

```


#### 9.  Посмотрите при помощи `ansible-doc` список плагинов для подключения. Выберите подходящий для работы на `control node`.

```
# ansible-doc -t connection -l | grep local
ansible.builtin.local          execute on controller   
```

#### 10. В `prod.yml` добавьте новую группу хостов с именем  `local`, в ней разместите localhost с необходимым типом подключения.
Дописали нужные строки, проверим
```
# cat inventory/prod.yml
---
  el:
    hosts:
      centos7:
        ansible_connection: docker
  deb:
    hosts:
      ubuntu:
        ansible_connection: docker


  local:
    hosts:
      localhost:
        ansible_connection: local
```

#### 11. Запустите playbook на окружении `prod.yml`. При запуске `ansible` должен запросить у вас пароль. Убедитесь что факты `some_fact` для каждого из хостов определены из верных `group_vars`.
Проверяем что все работает правильно
```
# ansible-playbook -i inventory/prod.yml site.yml --ask-vault-pass
Vault password:

PLAY [Print os facts] ******************************************************************************************************************************************************************************

TASK [Gathering Facts] *****************************************************************************************************************************************************************************
ok: [localhost]
ok: [ubuntu]
ok: [centos7]

TASK [Print OS] ************************************************************************************************************************************************************************************
ok: [ubuntu] => {
    "msg": "Ubuntu"
}
ok: [centos7] => {
    "msg": "CentOS"
}
ok: [localhost] => {
    "msg": "Debian"
}

TASK [Print fact] **********************************************************************************************************************************************************************************
ok: [centos7] => {
    "msg": "el default fact"
}
ok: [ubuntu] => {
    "msg": "deb default fact"
}
ok: [localhost] => {
    "msg": "all default fact"
}

PLAY RECAP *****************************************************************************************************************************************************************************************
centos7                    : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
localhost                  : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ubuntu                     : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

#### 12. Заполните `README.md` ответами на вопросы. Сделайте `git push` в ветку `master`. В ответе отправьте ссылку на ваш открытый репозиторий с изменённым `playbook` и заполненным `README.md`.
Ссылка на репозитарий: https://github.com/Artegro/ansible-8.1/tree/master

## Необязательная часть

#### 1. При помощи `ansible-vault` расшифруйте все зашифрованные файлы с переменными.
Расшифруем
```
# ansible-vault decrypt group_vars/deb/examp.yml
Vault password:
Decryption successful
# ansible-vault decrypt group_vars/el/examp.yml
Vault password:
Decryption successful
```
Проверим что все правильно
```
# cat group_vars/deb/examp.yml
---
  some_fact: "deb default fact"
# cat group_vars/el/examp.yml
---
  some_fact: "el default fact"
```
#### 2. Зашифруйте отдельное значение `PaSSw0rd` для переменной `some_fact` паролем `netology`. Добавьте полученное значение в `group_vars/all/exmp.yml`.

```
ansible-vault encrypt_string "PaSSw0rd"
New Vault password:
Confirm New Vault password:
Encryption successful
!vault |
          $ANSIBLE_VAULT;1.1;AES256
          36363736386161616635646330333462653438626339393932356136323336666237396662613231
          3766356266373832333137643462323265336461343634610a646436613065343235333264626664
          37316135623935666437396336366462393861363338333862356133623937363530613064613765
          3638376536343262340a313038656132656130376434386334306234306366353730313666376536
          3234
```
Проверяем
```
cat group_vars/all/examp.yml
---
  some_fact: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          36363736386161616635646330333462653438626339393932356136323336666237396662613231
          3766356266373832333137643462323265336461343634610a646436613065343235333264626664
          37316135623935666437396336366462393861363338333862356133623937363530613064613765
          3638376536343262340a313038656132656130376434386334306234306366353730313666376536
          3234
```

#### 3. Запустите `playbook`, убедитесь, что для нужных хостов применился новый `fact`.
Проверяем , все стартует и раотает правильно.
```
# ansible-playbook -i inventory/prod.yml site.yml --ask-vault-pass
Vault password:

PLAY [Print os facts] ******************************************************************************************************************************************************************************

TASK [Gathering Facts] *****************************************************************************************************************************************************************************
ok: [localhost]
ok: [ubuntu]
ok: [centos7]

TASK [Print OS] ************************************************************************************************************************************************************************************
ok: [centos7] => {
    "msg": "CentOS"
}
ok: [ubuntu] => {
    "msg": "Ubuntu"
}
ok: [localhost] => {
    "msg": "Debian"
}

TASK [Print fact] **********************************************************************************************************************************************************************************
ok: [centos7] => {
    "msg": "el default fact"
}
ok: [ubuntu] => {
    "msg": "deb default fact"
}
ok: [localhost] => {
    "msg": "PaSSw0rd"
}

PLAY RECAP *****************************************************************************************************************************************************************************************
centos7                    : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
localhost                  : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ubuntu                     : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

```

#### 4. Добавьте новую группу хостов `fedora`, самостоятельно придумайте для неё переменную. В качестве образа можно использовать [этот](https://hub.docker.com/r/pycontribs/fedora).

```

```

#### 5. Напишите скрипт на bash: автоматизируйте поднятие необходимых контейнеров, запуск ansible-playbook и остановку контейнеров.

Пропустил.. не очень понятно - каких автоматизации необходимы? если всех контейнеры подряд, то это перечисление команд из ДЗ в чистом виде по кругу.

#### 6. Все изменения должны быть зафиксированы и отправлены в вашей личный репозиторий.

```

```
